# Azure Deployment Fixes (2026-01-06)

## Summary

Production deployment on Azure Container Apps showed:

- `/api/analyze` returning `500` (client saw `Failed to load resource: 500`)
- `/api/rtass/rubrics` returning `500` (default scorecard rubrics not loading)

Both worked locally due to different runtime configuration and local filesystem availability.

## Root Causes

### 1) Analysis deployment mismatch (Azure env vs local `.env.local`)

In Azure, `ca-austin-rtass-prod` was configured with:

- `AZURE_OPENAI_GPT4_DEPLOYMENT=gpt-4o`

While the analysis code path is tuned around GPT-5-style usage and larger structured outputs. Azure OpenAI rejects incompatible requests/limits and the route surfaces this as `500`.

### 2) Built-in RTASS rubrics missing from the runtime image

`/api/rtass/rubrics` loads JSON files from `data/rtass-rubrics` at runtime (`process.cwd()/data/rtass-rubrics`).

The production container image (Next.js “standalone” runtime) did not include that folder, so `fs.readdir()` failed and returned a `500`.

## Fixes Implemented

### Azure configuration updates (Container App)

Applied to `ca-austin-rtass-prod`:

- `AZURE_OPENAI_WHISPER_DEPLOYMENT=gpt-4o-transcribe-diarize` (transcription + diarize)
- `AZURE_OPENAI_GPT5_DEPLOYMENT=gpt-5` (analysis)
- `AZURE_OPENAI_GPT4_DEPLOYMENT=gpt-5` (legacy fallback name still used in some places)
- `AZURE_OPENAI_API_VERSION=2024-12-01-preview`

### Analysis latency controls (to reduce gateway timeouts)

Added tunables used by all analysis strategies:

- `AZURE_OPENAI_REASONING_EFFORT=medium`
- `ANALYSIS_MAX_OUTPUT_TOKENS=4096` (output cap to reduce latency)

Defaults were adjusted so GPT-5 outputs are capped conservatively unless overridden.

### RTASS rubrics included in the runtime container

Fixed the Docker build/runtime packaging:

- `.dockerignore` now keeps `data/rtass-rubrics/**` in the build context.
- `Dockerfile` copies `/app/data/rtass-rubrics` into the runtime image.

### Build pipeline compatibility (ACR remote builds)

Azure Container Registry remote builds (`az acr build`) do not always run with BuildKit-enabled features.

- Removed the BuildKit-only `RUN --mount=type=cache` from `Dockerfile` so ACR builds succeed reliably.

### Entra ID auth secret

The Container App uses built-in auth (Entra ID) with a secret named `microsoft-provider-authentication-secret`.

- A fresh client secret was generated (append) for the shared Entra app and stored into the Container App secrets so auth can function.

## Deployed Artifacts

The Container App is currently deployed to an ACR-built tag (example):

- `acraustinrtassprod.azurecr.io/austin-rtass:prod-20260106011723`

## Verification Checklist

From a browser session that is signed in (Entra):

- Load the app and ensure the rubrics page/scorecard feature loads defaults (no `/api/rtass/rubrics` 500).
- Run analysis on a small transcript and confirm `/api/analyze` returns success and the UI completes.
- If analysis is still timing out for long transcripts, decrease `ANALYSIS_MAX_OUTPUT_TOKENS` further or switch strategy to `basic`.

## Notes / Known Issues

- Azure Container App exec occasionally returns platform `500` even when the app is healthy; use logs + revision status for debugging.
- The client console log from `Token Utils` is not authoritative for server configuration (client bundles can’t see server env vars).

