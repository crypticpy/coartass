name: Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/infrastructure.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'what-if'
        type: choice
        options:
          - what-if
          - deploy

env:
  LOCATION: eastus

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep templates
        run: |
          cd infrastructure
          az bicep build --file main.bicep
          echo "Bicep templates are valid"

  what-if:
    name: What-If Analysis
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' || github.event.inputs.action == 'what-if'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run what-if
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"

          cd infrastructure
          az deployment sub what-if \
            --location ${{ env.LOCATION }} \
            --template-file main.bicep \
            --parameters @parameters/${ENVIRONMENT}.bicepparam

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy')
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy infrastructure
        id: deploy
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          DEPLOYMENT_NAME="mtranscriber-${ENVIRONMENT}-$(date +%Y%m%d%H%M%S)"

          cd infrastructure

          OUTPUT=$(az deployment sub create \
            --name $DEPLOYMENT_NAME \
            --location ${{ env.LOCATION }} \
            --template-file main.bicep \
            --parameters @parameters/${ENVIRONMENT}.bicepparam \
            --query '{resourceGroup: properties.outputs.resourceGroupName.value, acrServer: properties.outputs.containerRegistryLoginServer.value, appUrl: properties.outputs.containerAppUrl.value}' \
            -o json)

          echo "deployment_output=$OUTPUT" >> $GITHUB_OUTPUT
          echo "Deployment completed successfully"
          echo "$OUTPUT" | jq .

      - name: Summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | ${{ env.LOCATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment outputs:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.deploy.outputs.deployment_output }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
